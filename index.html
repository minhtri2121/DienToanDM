<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Tìm đường đi bằng Leaflet</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <style>
    #map {
      height: 600px;
      width: 100%;
    }
    #control-panel {
      margin: 10px;
    }
    input[type="text"] {
      width: 200px;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h2>Tìm đường đi giữa các điểm bằng Leaflet</h2>
  <div id="control-panel">
    <label>Nhập tọa độ (lat,lng): </label>
    <input type="text" id="input-coord" placeholder="Ví dụ: 10.762622,106.660172" />
    <button id="btn-add-point">Thêm điểm</button>
    <button id="btn-clear">Xóa đường và điểm</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  // Khởi tạo bản đồ
  const map = L.map('map').setView([10.762622, 106.660172], 13); // Tọa độ TP.HCM

  // Thêm tile layer OpenStreetMap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap'
  }).addTo(map);

  // Các điểm bán hàng mẫu (cửa hàng)
  const stores = [
    { name: "Trang Xì Po NVC", coords: [10.765, 106.67] },
    { name: "Trang Xì Po Tạ Thị Phi", coords: [10.755, 106.65] },
    { name: "Trang Xì Po NVL", coords: [10.77, 106.66] }
  ];

  // Marker cửa hàng
  const storeMarkers = [];
  stores.forEach(store => {
    const marker = L.marker(store.coords).addTo(map)
      .bindPopup(store.name)
      .on('click', () => {
        addPoint(store.coords, store.name);
      });
    storeMarkers.push(marker);
  });

  // Danh sách điểm người dùng chọn (bao gồm điểm đứng và điểm cửa hàng)
  let routePoints = [];

  // Marker điểm người dùng chọn
  let pointMarkers = [];

  // Polyline đường đi
  let routeLine = null;

  // Icon đặc biệt cho vị trí hiện tại
  const currentLocationIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/64/64113.png', // icon vị trí hiện tại
    iconSize: [30, 40],
    iconAnchor: [15, 40],
    popupAnchor: [0, -35]
  });

  // Hàm thêm điểm vào danh sách và đánh dấu trên bản đồ
  function addPoint(latlng, label = null, isCurrentLocation = false) {
    routePoints.push(latlng);
    const markerOptions = isCurrentLocation ? { icon: currentLocationIcon, draggable: true } : { draggable: true };
    const marker = L.marker(latlng, markerOptions).addTo(map);
    if (label) {
      marker.bindPopup(label).openPopup();
    } else {
      marker.bindPopup(`Điểm ${routePoints.length}`).openPopup();
    }
    pointMarkers.push(marker);

    // Cho phép kéo marker để thay đổi tọa độ
    marker.on('dragend', function (e) {
      const idx = pointMarkers.indexOf(marker);
      if (idx !== -1) {
        routePoints[idx] = [e.target.getLatLng().lat, e.target.getLatLng().lng];
        drawRoute();
      }
    });

    drawRoute();
  }

  // Xóa tất cả điểm và đường
  function clearAll() {
    routePoints = [];
    pointMarkers.forEach(m => map.removeLayer(m));
    pointMarkers = [];
    if (routeLine) {
      map.removeLayer(routeLine);
      routeLine = null;
    }
  }

  // Vẽ đường đi dựa trên routePoints bằng API OSRM
  async function drawRoute() {
    if (routePoints.length < 2) {
      if (routeLine) {
        map.removeLayer(routeLine);
        routeLine = null;
      }
      return;
    }

    // Tạo chuỗi tọa độ cho OSRM
    const coordsStr = routePoints.map(p => p[1] + ',' + p[0]).join(';');

    // Gọi API OSRM public để lấy đường đi
    const url = `https://router.project-osrm.org/route/v1/driving/${coordsStr}?overview=full&geometries=geojson`;

    try {
      const res = await fetch(url);
      const data = await res.json();

      if (data.code !== 'Ok') {
        alert('Không tìm được đường đi');
        return;
      }

      const route = data.routes[0];
      const geojson = route.geometry;

      // Xóa đường cũ nếu có
      if (routeLine) {
        map.removeLayer(routeLine);
      }

      // Vẽ đường mới
      routeLine = L.geoJSON(geojson, {
        style: { color: 'blue', weight: 5 }
      }).addTo(map);

      // Zoom bản đồ vừa đủ chứa đường đi
      const bounds = routeLine.getBounds();
      map.fitBounds(bounds.pad(0.5));
    } catch (error) {
      alert('Lỗi khi lấy dữ liệu đường đi');
      console.error(error);
    }
  }

  // Xử lý click trên bản đồ để thêm điểm
  map.on('click', function (e) {
    addPoint([e.latlng.lat, e.latlng.lng]);
    alert(`Bạn đã chọn điểm tại: ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`);
  });

  // Xử lý nút thêm điểm nhập tay
  document.getElementById('btn-add-point').addEventListener('click', () => {
    const input = document.getElementById('input-coord').value.trim();
    if (!input) {
      alert('Vui lòng nhập tọa độ');
      return;
    }
    const parts = input.split(',');
    if (parts.length !== 2) {
      alert('Vui lòng nhập đúng định dạng: lat,lng');
      return;
    }
    const lat = parseFloat(parts[0]);
    const lng = parseFloat(parts[1]);
    if (isNaN(lat) || isNaN(lng)) {
      alert('Tọa độ không hợp lệ');
      return;
    }
    addPoint([lat, lng]);
    document.getElementById('input-coord').value = '';
  });

  // Xử lý nút xóa
  document.getElementById('btn-clear').addEventListener('click', () => {
    clearAll();
  });

  // Tự động lấy vị trí hiện tại của người dùng (nếu cho phép)
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        const latlng = [pos.coords.latitude, pos.coords.longitude];
        // Thêm vị trí hiện tại vào đầu danh sách điểm (điểm đầu tiên)
        routePoints.unshift(latlng);
        const marker = L.marker(latlng, { icon: currentLocationIcon, draggable: true }).addTo(map)
          .bindPopup("Vị trí hiện tại của bạn").openPopup();

        pointMarkers.unshift(marker);

        map.setView(latlng, 14);

        // Cho phép kéo marker vị trí hiện tại để cập nhật tọa độ và đường đi
        marker.on('dragend', function (e) {
          routePoints[0] = [e.target.getLatLng().lat, e.target.getLatLng().lng];
          drawRoute();
        });

        drawRoute();
      },
      err => {
        console.log('Không thể lấy vị trí hiện tại');
      }
    );
  }
</script>

</body>
</html>
